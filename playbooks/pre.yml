---
- name: Pre play
  hosts: all

  vars_files:
    - vars/cloud_envs.yml

  tasks:
    - name: Set cloud_env fact (Zuul deployment)
      ansible.builtin.set_fact:
        cloud_env: "{{ cloud_envs[hostvars[groups['all'][0]]['nodepool']['label']] }}"
      when: "'nodepool' in hostvars[groups['all'][0]]"

    - name: Set cloud_env fact (local deployment)
      ansible.builtin.set_fact:
        cloud_env: "{{ testbed_environment | default('ci') }}"
      when: "'nodepool' not in hostvars[groups['all'][0]]"

    - name: Clean the cloud environment
      ansible.builtin.shell:
        cmd: |
          echo y | ~/venv/bin/openstack --os-cloud {{ cloud_env }} project cleanup --auth-project
          ~/venv/bin/openstack --os-cloud {{ cloud_env }} port list -f value -c id | xargs -l1 ~/venv/bin/openstack --os-cloud {{ cloud_env }} port delete
          ~/venv/bin/openstack --os-cloud {{ cloud_env }} router remove subnet testbed subnet-testbed-management
          ~/venv/bin/openstack --os-cloud {{ cloud_env }} router delete testbed
          echo y | ~/venv/bin/openstack --os-cloud {{ cloud_env }} project cleanup --auth-project
          ~/venv/bin/openstack --os-cloud {{ cloud_env }} keypair delete testbed
      failed_when: false
